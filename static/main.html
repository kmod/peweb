<!doctype html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/static/main.css" />
        <script src="/static/react-with-addons.js"></script>
        <script src="/static/jquery-2.1.1.js"></script>
        <script src="/static/JSXTransformer.js"></script>
    </head>
    <body>
        <div id="content"></div>
        <script type="text/jsx">
            /** @jsx React.DOM */
            var Library = React.createClass({
                getInitialState: function() {
                    return {shelves: [], selectedShelf: null};
                },
                loadShelves: function() {
                    var url = "/shelves";
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        success: function(shelves) {
                            this.setState({shelves: shelves});
                        }.bind(this),
                        error: function(xhr, status, err) {
                            console.error(url, status, err.toString());
                        }.bind(this)
                    });
                },
                componentDidMount: function() {
                    this.loadShelves();
                    //setInterval(this.loadShelves, this.props.pollInterval);
                },

                handleShelfCreate: function(shelf, cb) {
                    var shelves = this.state.shelves;
                    //var new_shelves = shelves.concat([shelf]);
                    //this.setState({shelves: new_shelves});
                    var url = "/create_shelf";
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        type: 'POST',
                        data: shelf,
                        success: function(shelves) {
                            this.setState({shelves: shelves});
                            cb(true);
                        }.bind(this),
                        error: function(xhr, status, err) {
                            this.setState({shelves: shelves});
                            console.error(url, status, err.toString());
                            cb(false);
                        }.bind(this)
                    });
                },

                handleShelfDelete: function(shelf) {
                    var shelves = this.state.shelves;
                    //var new_shelves = shelves; // remove shelf
                    //this.setState({shelves: new_shelves});
                    var url = "/delete_shelf";
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        type: 'POST',
                        data: {shelf_id: shelf.id},
                        success: function(shelves) {
                            this.setState({shelves: shelves});
                        }.bind(this),
                        error: function(xhr, status, err) {
                            this.setState({shelves: shelves});
                            console.error(url, status, err.toString());
                        }.bind(this)
                    });
                },

                handleShelfClick: function(shelf) {
                    this.state.selectedShelf = shelf;
                    this.setState(this.state)
                },

                render: function() {
                    var shelves = this.state.shelves.map(function (shelf) {
                        return (
                        <ShelfHeader data={shelf} key={shelf.id} handleShelfDelete={this.handleShelfDelete} handleShelfClick={this.handleShelfClick} />
                        );
                    }.bind(this));

                    var view = "";
                    if (this.state.selectedShelf)
                    view = (
                    <ShelfView shelf={this.state.selectedShelf} />
                    );


                    return (
                    <div>
                        <div className="shelf_list">
                            <h2>Your shelves:</h2>
                            {shelves}
                            <CreateShelfForm onCreateShelf={this.handleShelfCreate} />
                        </div>

                        {view}
                    </div>
                    );
                },
            });

            var ShelfView = React.createClass({
                getInitialState: function() {
                    return {shelf: null};
                },

                render: function() {
                    return (
                    <div className="shelfview">
                        <h2> {this.props.shelf.name} </h2>
                    </div>
                    );
                }
            });

            var ShelfHeader = React.createClass({
                handleDelete: function(e) {
                    e.preventDefault();

                    this.props.handleShelfDelete(this.props.data);
                },

                handleShelfClick: function(e) {
                    e.preventDefault();

                    this.props.handleShelfClick(this.props.data);
                },

                render: function() {
                    return (
                    <div className="shelf_header" onClick={this.handleShelfClick}>
                        <span className="shelf_name">{this.props.data.name}</span>

                        <form className="delete_shelf" onSubmit={this.handleDelete}>
                            <input type="submit" value="Delete shelf" />
                        </form>
                    </div>
                    )
                },
            });

            var CreateShelfForm = React.createClass({
                handleSubmit: function(e) {
                    e.preventDefault();

                    var name_node = this.refs.name.getDOMNode();
                    var name = name_node.value.trim();
                    if (!name) {
                        return;
                    }

                    var cb = function(success) {
                        name_node.disabled = false;
                        if (success)
                            name_node.value = '';
                    };

                    name_node.disabled = true;
                    this.props.onCreateShelf({name: name}, cb);
                    return;
                },
                render: function() {
                    return (
                    <form className="createShelfForm" onSubmit={this.handleSubmit}>
                        Create shelf:
                        <input type="text" placeholder="Shelf name" ref="name" />
                        <input type="submit" value="Create" />
                    </form>
                    )
                },
            });

            React.renderComponent(
            <Library />,
            document.getElementById('content')
            );
        </script>
    </body>
</html>

